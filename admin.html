<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard (Auto-Save) - Create Military Department</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <style>
        .admin-container { padding-top: 8rem; max-width: 900px; margin: 0 auto; padding-bottom: 5rem; }
        .form-group { margin-bottom: 2rem; background: var(--bg-card); padding: 2rem; border-radius: 20px; border: 1px solid var(--border); }
        .form-group h2 { margin-bottom: 1.5rem; }
        label { display: block; margin-bottom: 0.5rem; color: var(--text-secondary); }
        input, textarea, select { width: 100%; padding: 0.8rem; border-radius: 8px; background: #020617; border: 1px solid var(--border); color: white; margin-bottom: 1rem; }
        .setup-box { border-color: var(--primary); background: rgba(99, 102, 241, 0.05); }
        .status-msg { margin-top: 1rem; font-weight: 600; padding: 1rem; border-radius: 8px; display: none; }
        .success { background: rgba(16, 185, 129, 0.1); color: #10b981; border: 1px solid #10b981; }
        .error { background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid #ef4444; }
    </style>
</head>
<body>
    <div class="bg-glow"></div>
    <nav>
        <a href="index.html" class="nav-logo">Create Military [Auto-Admin]</a>
        <div class="nav-links">
            <a href="index.html">Back to Home</a>
        </div>
    </nav>

    <main class="admin-container">
        <div class="section-header">
            <h1>Auto Admin Panel</h1>
            <p>GitHub API を使用して、サイトのデータを直接更新します。</p>
        </div>

        <!-- Setup Step -->
        <div class="form-group setup-box">
            <h2>Step 1: Authorization</h2>
            <label>GitHub Personal Access Token (PAT)</label>
            <input type="password" id="gh-token" placeholder="ghp_xxxxxxxxxxxx">
            <p style="font-size: 0.8rem; color: var(--text-secondary);">※トークンはブラウザ内のみで使用され、保存されません。repo スコープが必要です。</p>
        </div>

        <!-- Add Wiki Block -->
        <div class="form-group">
            <h2>Add Wiki Block</h2>
            <label>Name</label>
            <input type="text" id="b-name" placeholder="Military Gearbox">
            <label>Icon (Emoji or URL)</label>
            <input type="text" id="b-icon" placeholder="⚙️">
            <label>Description</label>
            <textarea id="b-desc" rows="2"></textarea>
            <label>Specs (Comma separated)</label>
            <input type="text" id="b-specs" placeholder="Spec 1, Spec 2">
            <button class="btn btn-primary" onclick="saveToGitHub('wiki')">Save to GitHub Wiki</button>
        </div>

        <!-- Add Gallery Item -->
        <div class="form-group">
            <h2>Add Gallery Item</h2>
            <label>Title</label>
            <input type="text" id="g-title" placeholder="Super Tank">
            <label>Author</label>
            <input type="text" id="g-author" placeholder="Username">
            <label>Image URL</label>
            <input type="text" id="g-img" placeholder="../assets/img/your-image.png">
            <label>Description</label>
            <textarea id="g-desc" rows="2"></textarea>
            <button class="btn btn-primary" onclick="saveToGitHub('gallery')">Save to GitHub Gallery</button>
        </div>

        <div id="status" class="status-msg"></div>
    </main>

    <script>
        // 設定用（あなたのリポジトリ情報に合わせて変更してください）
        const OWNER = 'AshViper';
        const REPO = 'CreateMilitaryDepartment-Website';

        async function saveToGitHub(type) {
            const token = document.getElementById('gh-token').value;
            const statusDiv = document.getElementById('status');
            
            if (!token) {
                alert('GitHub Tokenを入力してください');
                return;
            }

            statusDiv.style.display = 'block';
            statusDiv.className = 'status-msg';
            statusDiv.textContent = 'Updating...';

            try {
                const path = type === 'wiki' ? 'data/blocks.json' : 'data/gallery.json';
                
                // 1. 現在のファイル内容を取得
                const getUrl = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${path}`;
                const getRes = await fetch(getUrl, {
                    headers: { 'Authorization': `token ${token}` }
                });
                
                if (!getRes.ok) throw new Error('Failed to fetch current data');
                const fileData = await getRes.json();
                const currentContent = JSON.parse(atob(fileData.content));

                // 2. 新しいデータを追加
                let newData;
                if (type === 'wiki') {
                    newData = {
                        id: document.getElementById('b-name').value.toLowerCase().replace(/\s+/g, '-'),
                        name: document.getElementById('b-name').value,
                        icon: document.getElementById('b-icon').value,
                        description: document.getElementById('b-desc').value,
                        specs: document.getElementById('b-specs').value.split(',').map(s => s.trim())
                    };
                } else {
                    newData = {
                        title: document.getElementById('g-title').value,
                        author: document.getElementById('g-author').value,
                        image: document.getElementById('g-img').value,
                        description: document.getElementById('g-desc').value
                    };
                }
                
                currentContent.push(newData);

                // 3. GitHubへプッシュ（コミット）
                const updateRes = await fetch(getUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Admin: Add new ${type} item via Web Dashboard`,
                        content: btoa(unescape(encodeURIComponent(JSON.stringify(currentContent, null, 2)))),
                        sha: fileData.sha // 上書きに必要
                    })
                });

                if (updateRes.ok) {
                    statusDiv.className = 'status-msg success';
                    statusDiv.textContent = 'Successfully saved! サイトへの反映には2〜3分かかります。';
                    // フォームクリア
                    if(type === 'wiki') document.querySelectorAll('.form-group input, .form-group textarea').forEach(i => if(i.id.startsWith('b-')) i.value = '');
                    else document.querySelectorAll('.form-group input, .form-group textarea').forEach(i => if(i.id.startsWith('g-')) i.value = '');
                } else {
                    throw new Error('Update failed');
                }

            } catch (err) {
                statusDiv.className = 'status-msg error';
                statusDiv.textContent = 'Error: ' + err.message;
                console.error(err);
            }
        }
    </script>
</body>
</html>
